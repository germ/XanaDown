import * as utils from '@interactjs/utils';
function start(arg) {
    const { interaction, interactable, element, rect, state, startOffset } = arg;
    const { options } = state;
    const offsets = [];
    const origin = options.offsetWithOrigin
        ? getOrigin(arg)
        : { x: 0, y: 0 };
    let snapOffset;
    if (options.offset === 'startCoords') {
        snapOffset = {
            x: interaction.coords.start.page.x,
            y: interaction.coords.start.page.y,
        };
    }
    else {
        const offsetRect = utils.rect.resolveRectLike(options.offset, interactable, element, [interaction]);
        snapOffset = utils.rect.rectToXY(offsetRect) || { x: 0, y: 0 };
        snapOffset.x += origin.x;
        snapOffset.y += origin.y;
    }
    const relativePoints = options.relativePoints || [];
    if (rect && options.relativePoints && options.relativePoints.length) {
        for (let index = 0; index < relativePoints.length; index++) {
            const relativePoint = relativePoints[index];
            offsets.push({
                index,
                relativePoint,
                x: startOffset.left - (rect.width * relativePoint.x) + snapOffset.x,
                y: startOffset.top - (rect.height * relativePoint.y) + snapOffset.y,
            });
        }
    }
    else {
        offsets.push(utils.extend({
            index: 0,
            relativePoint: null,
        }, snapOffset));
    }
    state.offsets = offsets;
}
function set(arg) {
    const { interaction, coords, state } = arg;
    const { options, offsets } = state;
    const origin = utils.getOriginXY(interaction.interactable, interaction.element, interaction.prepared.name);
    const page = utils.extend({}, coords);
    const targets = [];
    let target;
    if (!options.offsetWithOrigin) {
        page.x -= origin.x;
        page.y -= origin.y;
    }
    state.realX = page.x;
    state.realY = page.y;
    for (const offset of offsets) {
        const relativeX = page.x - offset.x;
        const relativeY = page.y - offset.y;
        for (let index = 0, len = options.targets.length; index < len; index++) {
            const snapTarget = options.targets[index];
            if (utils.is.func(snapTarget)) {
                target = snapTarget(relativeX, relativeY, interaction, offset, index);
            }
            else {
                target = snapTarget;
            }
            if (!target) {
                continue;
            }
            targets.push({
                x: (utils.is.number(target.x) ? target.x : relativeX) + offset.x,
                y: (utils.is.number(target.y) ? target.y : relativeY) + offset.y,
                range: utils.is.number(target.range) ? target.range : options.range,
            });
        }
    }
    const closest = {
        target: null,
        inRange: false,
        distance: 0,
        range: 0,
        dx: 0,
        dy: 0,
    };
    for (let i = 0, len = targets.length; i < len; i++) {
        target = targets[i];
        const range = target.range;
        const dx = target.x - page.x;
        const dy = target.y - page.y;
        const distance = utils.hypot(dx, dy);
        let inRange = distance <= range;
        // Infinite targets count as being out of range
        // compared to non infinite ones that are in range
        if (range === Infinity && closest.inRange && closest.range !== Infinity) {
            inRange = false;
        }
        if (!closest.target || (inRange
            // is the closest target in range?
            ? (closest.inRange && range !== Infinity
                // the pointer is relatively deeper in this target
                ? distance / range < closest.distance / closest.range
                // this target has Infinite range and the closest doesn't
                : (range === Infinity && closest.range !== Infinity) ||
                    // OR this target is closer that the previous closest
                    distance < closest.distance)
            // The other is not in range and the pointer is closer to this target
            : (!closest.inRange && distance < closest.distance))) {
            closest.target = target;
            closest.distance = distance;
            closest.range = range;
            closest.inRange = inRange;
            closest.dx = dx;
            closest.dy = dy;
            state.range = range;
        }
    }
    if (closest.inRange) {
        coords.x = closest.target.x;
        coords.y = closest.target.y;
    }
    state.closest = closest;
}
function getOrigin(arg) {
    const optionsOrigin = utils.rect.rectToXY(utils.rect.resolveRectLike(arg.state.options.origin));
    const origin = optionsOrigin || utils.getOriginXY(arg.interactable, arg.interaction.element, arg.interaction.prepared.name);
    return origin;
}
const snap = {
    start,
    set,
    defaults: {
        enabled: false,
        range: Infinity,
        targets: null,
        offset: null,
        offsetWithOrigin: true,
        relativePoints: null,
    },
};
export default snap;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9pbnRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInBvaW50ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEtBQUssTUFBTSxtQkFBbUIsQ0FBQTtBQUUxQyxTQUFTLEtBQUssQ0FBRSxHQUF1QjtJQUNyQyxNQUFNLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsR0FBRyxHQUFHLENBQUE7SUFDNUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxHQUFHLEtBQUssQ0FBQTtJQUN6QixNQUFNLE9BQU8sR0FBRyxFQUFFLENBQUE7SUFDbEIsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLGdCQUFnQjtRQUNyQyxDQUFDLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQztRQUNoQixDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQTtJQUVsQixJQUFJLFVBQVUsQ0FBQTtJQUVkLElBQUksT0FBTyxDQUFDLE1BQU0sS0FBSyxhQUFhLEVBQUU7UUFDcEMsVUFBVSxHQUFHO1lBQ1gsQ0FBQyxFQUFFLFdBQVcsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2xDLENBQUMsRUFBRSxXQUFXLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNuQyxDQUFBO0tBQ0Y7U0FDSztRQUNKLE1BQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUE7UUFFbkcsVUFBVSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxF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LEVBQUUsSUFBSTtRQUV0QixjQUFjLEVBQUUsSUFBSTtLQUNyQjtDQUNGLENBQUE7QUFFRCxlQUFlLElBQUksQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHV0aWxzIGZyb20gJ0BpbnRlcmFjdGpzL3V0aWxzJ1xuXG5mdW5jdGlvbiBzdGFydCAoYXJnOiBJbnRlcmFjdC5TaWduYWxBcmcpIHtcbiAgY29uc3QgeyBpbnRlcmFjdGlvbiwgaW50ZXJhY3RhYmxlLCBlbGVtZW50LCByZWN0LCBzdGF0ZSwgc3RhcnRPZmZzZXQgfSA9IGFyZ1xuICBjb25zdCB7IG9wdGlvbnMgfSA9IHN0YXRlXG4gIGNvbnN0IG9mZnNldHMgPSBbXVxuICBjb25zdCBvcmlnaW4gPSBvcHRpb25zLm9mZnNldFdpdGhPcmlnaW5cbiAgICA/IGdldE9yaWdpbihhcmcpXG4gICAgOiB7IHg6IDAsIHk6IDAgfVxuXG4gIGxldCBzbmFwT2Zmc2V0XG5cbiAgaWYgKG9wdGlvbnMub2Zmc2V0ID09PSAnc3RhcnRDb29yZHMnKSB7XG4gICAgc25hcE9mZnNldCA9IHtcbiAgICAgIHg6IGludGVyYWN0aW9uLmNvb3Jkcy5zdGFydC5wYWdlLngsXG4gICAgICB5OiBpbnRlcmFjdGlvbi5jb29yZHMuc3RhcnQucGFnZS55LFxuICAgIH1cbiAgfVxuICBlbHNlICB7XG4gICAgY29uc3Qgb2Zmc2V0UmVjdCA9IHV0aWxzLnJlY3QucmVzb2x2ZVJlY3RMaWtlKG9wdGlvbnMub2Zmc2V0LCBpbnRlcmFjdGFibGUsIGVsZW1lbnQsIFtpbnRlcmFjdGlvbl0pXG5cbiAgICBzbmFwT2Zmc2V0ID0gdXRpbHMucmVjdC5yZWN0VG9YWShvZmZzZXRSZWN0KSB8fCB7IHg6IDAsIHk6IDAgfVxuICAgIHNuYXBPZmZzZXQueCArPSBvcmlnaW4ueFxuICAgIHNuYXBPZmZzZXQueSArPSBvcmlnaW4ueVxuICB9XG5cbiAgY29uc3QgcmVsYXRpdmVQb2ludHMgPSBvcHRpb25zLnJlbGF0aXZlUG9pbnRzIHx8IFtdXG5cbiAgaWYgKHJlY3QgJiYgb3B0aW9ucy5yZWxhdGl2ZVBvaW50cyAmJiBvcHRpb25zLnJlbGF0aXZlUG9pbnRzLmxlbmd0aCkge1xuICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCByZWxhdGl2ZVBvaW50cy5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgIGNvbnN0IHJlbGF0aXZlUG9pbnQgPSByZWxhdGl2ZVBvaW50c1tpbmRleF1cblxuICAgICAgb2Zmc2V0cy5wdXNoKHtcbiAgICAgICAgaW5kZXgsXG4gICAgICAgIHJlbGF0aXZlUG9pbnQsXG4gICAgICAgIHg6IHN0YXJ0T2Zmc2V0LmxlZnQgLSAocmVjdC53aWR0aCAgKiByZWxhdGl2ZVBvaW50LngpICsgc25hcE9mZnNldC54LFxuICAgICAgICB5OiBzdGFydE9mZnNldC50b3AgIC0gKHJlY3QuaGVpZ2h0ICogcmVsYXRpdmVQb2ludC55KSArIHNuYXBPZmZzZXQueSxcbiAgICAgIH0pXG4gICAgfVxuICB9XG4gIGVsc2Uge1xuICAgIG9mZnNldHMucHVzaCh1dGlscy5leHRlbmQoe1xuICAgICAgaW5kZXg6IDAsXG4gICAgICByZWxhdGl2ZVBvaW50OiBudWxsLFxuICAgIH0sIHNuYXBPZmZzZXQpKVxuICB9XG5cbiAgc3RhdGUub2Zmc2V0cyA9IG9mZnNldHNcbn1cblxuZnVuY3Rpb24gc2V0IChhcmc6IEludGVyYWN0LlNpZ25hbEFyZykge1xuICBjb25zdCB7IGludGVyYWN0aW9uLCBjb29yZHMsIHN0YXRlIH0gPSBhcmdcbiAgY29uc3QgeyBvcHRpb25zLCBvZmZzZXRzIH0gPSBzdGF0ZVxuXG4gIGNvbnN0IG9yaWdpbiA9IHV0aWxzLmdldE9yaWdpblhZKGludGVyYWN0aW9uLmludGVyYWN0YWJsZSwgaW50ZXJhY3Rpb24uZWxlbWVudCwgaW50ZXJhY3Rpb24ucHJlcGFyZWQubmFtZSlcbiAgY29uc3QgcGFnZSA9IHV0aWxzLmV4dGVuZCh7fSwgY29vcmRzKVxuICBjb25zdCB0YXJnZXRzID0gW11cbiAgbGV0IHRhcmdldFxuXG4gIGlmICghb3B0aW9ucy5vZmZzZXRXaXRoT3JpZ2luKSB7XG4gICAgcGFnZS54IC09IG9yaWdpbi54XG4gICAgcGFnZS55IC09IG9yaWdpbi55XG4gIH1cblxuICBzdGF0ZS5yZWFsWCA9IHBhZ2UueFxuICBzdGF0ZS5yZWFsWSA9IHBhZ2UueVxuXG4gIGZvciAoY29uc3Qgb2Zmc2V0IG9mIG9mZnNldHMpIHtcbiAgICBjb25zdCByZWxhdGl2ZVggPSBwYWdlLnggLSBvZmZzZXQueFxuICAgIGNvbnN0IHJlbGF0aXZlWSA9IHBhZ2UueSAtIG9mZnNldC55XG5cbiAgICBmb3IgKGxldCBpbmRleCA9IDAsIGxlbiA9IG9wdGlvbnMudGFyZ2V0cy5sZW5ndGg7IGluZGV4IDwgbGVuOyBpbmRleCsrKSB7XG4gICAgICBjb25zdCBzbmFwVGFyZ2V0ID0gb3B0aW9ucy50YXJnZXRzW2luZGV4XVxuICAgICAgaWYgKHV0aWxzLmlzLmZ1bmMoc25hcFRhcmdldCkpIHtcbiAgICAgICAgdGFyZ2V0ID0gc25hcFRhcmdldChyZWxhdGl2ZVgsIHJlbGF0aXZlWSwgaW50ZXJhY3Rpb24sIG9mZnNldCwgaW5kZXgpXG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgdGFyZ2V0ID0gc25hcFRhcmdldFxuICAgICAgfVxuXG4gICAgICBpZiAoIXRhcmdldCkgeyBjb250aW51ZSB9XG5cbiAgICAgIHRhcmdldHMucHVzaCh7XG4gICAgICAgIHg6ICh1dGlscy5pcy5udW1iZXIodGFyZ2V0LngpID8gdGFyZ2V0LnggOiByZWxhdGl2ZVgpICsgb2Zmc2V0LngsXG4gICAgICAgIHk6ICh1dGlscy5pcy5udW1iZXIodGFyZ2V0LnkpID8gdGFyZ2V0LnkgOiByZWxhdGl2ZVkpICsgb2Zmc2V0LnksXG5cbiAgICAgICAgcmFuZ2U6IHV0aWxzLmlzLm51bWJlcih0YXJnZXQucmFuZ2UpID8gdGFyZ2V0LnJhbmdlIDogb3B0aW9ucy5yYW5nZSxcbiAgICAgIH0pXG4gICAgfVxuICB9XG5cbiAgY29uc3QgY2xvc2VzdCA9IHtcbiAgICB0YXJnZXQ6IG51bGwsXG4gICAgaW5SYW5nZTogZmFsc2UsXG4gICAgZGlzdGFuY2U6IDAsXG4gICAgcmFuZ2U6IDAsXG4gICAgZHg6IDAsXG4gICAgZHk6IDAsXG4gIH1cblxuICBmb3IgKGxldCBpID0gMCwgbGVuID0gdGFyZ2V0cy5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgIHRhcmdldCA9IHRhcmdldHNbaV1cblxuICAgIGNvbnN0IHJhbmdlID0gdGFyZ2V0LnJhbmdlXG4gICAgY29uc3QgZHggPSB0YXJnZXQueCAtIHBhZ2UueFxuICAgIGNvbnN0IGR5ID0gdGFyZ2V0LnkgLSBwYWdlLnlcbiAgICBjb25zdCBkaXN0YW5jZSA9IHV0aWxzLmh5cG90KGR4LCBkeSlcbiAgICBsZXQgaW5SYW5nZSA9IGRpc3RhbmNlIDw9IHJhbmdlXG5cbiAgICAvLyBJbmZpbml0ZSB0YXJnZXRzIGNvdW50IGFzIGJlaW5nIG91dCBvZiByYW5nZVxuICAgIC8vIGNvbXBhcmVkIHRvIG5vbiBpbmZpbml0ZSBvbmVzIHRoYXQgYXJlIGluIHJhbmdlXG4gICAgaWYgKHJhbmdlID09PSBJbmZpbml0eSAmJiBjbG9zZXN0LmluUmFuZ2UgJiYgY2xvc2VzdC5yYW5nZSAhPT0gSW5maW5pdHkpIHtcbiAgICAgIGluUmFuZ2UgPSBmYWxzZVxuICAgIH1cblxuICAgIGlmICghY2xvc2VzdC50YXJnZXQgfHwgKGluUmFuZ2VcbiAgICAgIC8vIGlzIHRoZSBjbG9zZXN0IHRhcmdldCBpbiByYW5nZT9cbiAgICAgID8gKGNsb3Nlc3QuaW5SYW5nZSAmJiByYW5nZSAhPT0gSW5maW5pdHlcbiAgICAgICAgLy8gdGhlIHBvaW50ZXIgaXMgcmVsYXRpdmVseSBkZWVwZXIgaW4gdGhpcyB0YXJnZXRcbiAgICAgICAgPyBkaXN0YW5jZSAvIHJhbmdlIDwgY2xvc2VzdC5kaXN0YW5jZSAvIGNsb3Nlc3QucmFuZ2VcbiAgICAgICAgLy8gdGhpcyB0YXJnZXQgaGFzIEluZmluaXRlIHJhbmdlIGFuZCB0aGUgY2xvc2VzdCBkb2Vzbid0XG4gICAgICAgIDogKHJhbmdlID09PSBJbmZpbml0eSAmJiBjbG9zZXN0LnJhbmdlICE9PSBJbmZpbml0eSkgfHxcbiAgICAgICAgICAvLyBPUiB0aGlzIHRhcmdldCBpcyBjbG9zZXIgdGhhdCB0aGUgcHJldmlvdXMgY2xvc2VzdFxuICAgICAgICAgIGRpc3RhbmNlIDwgY2xvc2VzdC5kaXN0YW5jZSlcbiAgICAgIC8vIFRoZSBvdGhlciBpcyBub3QgaW4gcmFuZ2UgYW5kIHRoZSBwb2ludGVyIGlzIGNsb3NlciB0byB0aGlzIHRhcmdldFxuICAgICAgOiAoIWNsb3Nlc3QuaW5SYW5nZSAmJiBkaXN0YW5jZSA8IGNsb3Nlc3QuZGlzdGFuY2UpKSkge1xuICAgICAgY2xvc2VzdC50YXJnZXQgPSB0YXJnZXRcbiAgICAgIGNsb3Nlc3QuZGlzdGFuY2UgPSBkaXN0YW5jZVxuICAgICAgY2xvc2VzdC5yYW5nZSA9IHJhbmdlXG4gICAgICBjbG9zZXN0LmluUmFuZ2UgPSBpblJhbmdlXG4gICAgICBjbG9zZXN0LmR4ID0gZHhcbiAgICAgIGNsb3Nlc3QuZHkgPSBkeVxuXG4gICAgICBzdGF0ZS5yYW5nZSA9IHJhbmdlXG4gICAgfVxuICB9XG5cbiAgaWYgKGNsb3Nlc3QuaW5SYW5nZSkge1xuICAgIGNvb3Jkcy54ID0gY2xvc2VzdC50YXJnZXQueFxuICAgIGNvb3Jkcy55ID0gY2xvc2VzdC50YXJnZXQueVxuICB9XG5cbiAgc3RhdGUuY2xvc2VzdCA9IGNsb3Nlc3Rcbn1cblxuZnVuY3Rpb24gZ2V0T3JpZ2luIChhcmc6IFBhcnRpYWw8SW50ZXJhY3QuU2lnbmFsQXJnPikge1xuICBjb25zdCBvcHRpb25zT3JpZ2luID0gdXRpbHMucmVjdC5yZWN0VG9YWShcbiAgICB1dGlscy5yZWN0LnJlc29sdmVSZWN0TGlrZShhcmcuc3RhdGUub3B0aW9ucy5vcmlnaW4pXG4gIClcbiAgY29uc3Qgb3JpZ2luID0gb3B0aW9uc09yaWdpbiB8fCB1dGlscy5nZXRPcmlnaW5YWShcbiAgICBhcmcuaW50ZXJhY3RhYmxlLFxuICAgIGFyZy5pbnRlcmFjdGlvbi5lbGVtZW50LFxuICAgIGFyZy5pbnRlcmFjdGlvbi5wcmVwYXJlZC5uYW1lLFxuICApXG5cbiAgcmV0dXJuIG9yaWdpblxufVxuXG5jb25zdCBzbmFwID0ge1xuICBzdGFydCxcbiAgc2V0LFxuICBkZWZhdWx0czoge1xuICAgIGVuYWJsZWQ6IGZhbHNlLFxuICAgIHJhbmdlICA6IEluZmluaXR5LFxuICAgIHRhcmdldHM6IG51bGwsXG4gICAgb2Zmc2V0OiBudWxsLFxuICAgIG9mZnNldFdpdGhPcmlnaW46IHRydWUsXG5cbiAgICByZWxhdGl2ZVBvaW50czogbnVsbCxcbiAgfSxcbn1cblxuZXhwb3J0IGRlZmF1bHQgc25hcFxuIl19